<link rel="import" href="../polymer/polymer.html">

<dom-module id="ugo-previewer">
    <template>
        <content id="contentPreviewer" select="img, video, audio, a"></content>
        <style>
            :host ::content a {
                color: #00468C;
            }

            :host ::content .preview-icon path {
                fill: currentColor;
            }

            :host ::content .preview-icon {
                display: block;
                width: 48px;
                height: 48px;
                color: currentColor;
                fill: currentColor;
            }
        </style>
        <svg style="position: absolute; width: 0; height: 0;" width="0" height="0" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <defs>
                <symbol id="icon-file-empty" viewBox="0 0 1024 1024">
                    <title>file-empty</title>
                    <path fill="#444444" class="path1" d="M917.806 229.076c-22.212-30.292-53.174-65.7-87.178-99.704s-69.412-64.964-99.704-87.178c-51.574-37.82-76.592-42.194-90.924-42.194h-496c-44.112 0-80 35.888-80 80v864c0 44.112 35.888 80 80 80h736c44.112 0 80-35.888 80-80v-624c0-14.332-4.372-39.35-42.194-90.924zM785.374 174.626c30.7 30.7 54.8 58.398 72.58 81.374h-153.954v-153.946c22.984 17.78 50.678 41.878 81.374 72.572zM896 944c0 8.672-7.328 16-16 16h-736c-8.672 0-16-7.328-16-16v-864c0-8.672 7.328-16 16-16 0 0 495.956-0.002 496 0v224c0 17.672 14.326 32 32 32h224v624z"></path>
                </symbol>
                <symbol id="icon-file-picture" viewBox="0 0 1024 1024">
                    <title>file-picture</title>
                    <path fill="#444444" class="path1" d="M832 896h-640v-128l192-320 263 320 185-128v256z"></path>
                    <path fill="#444444" class="path2" d="M832 480c0 53.020-42.98 96-96 96-53.022 0-96-42.98-96-96s42.978-96 96-96c53.020 0 96 42.98 96 96z"></path>
                    <path fill="#444444" class="path3" d="M917.806 229.076c-22.212-30.292-53.174-65.7-87.178-99.704s-69.412-64.964-99.704-87.178c-51.574-37.82-76.592-42.194-90.924-42.194h-496c-44.112 0-80 35.888-80 80v864c0 44.112 35.888 80 80 80h736c44.112 0 80-35.888 80-80v-624c0-14.332-4.372-39.35-42.194-90.924zM785.374 174.626c30.7 30.7 54.8 58.398 72.58 81.374h-153.954v-153.946c22.984 17.78 50.678 41.878 81.374 72.572zM896 944c0 8.672-7.328 16-16 16h-736c-8.672 0-16-7.328-16-16v-864c0-8.672 7.328-16 16-16 0 0 495.956-0.002 496 0v224c0 17.672 14.326 32 32 32h224v624z"></path>
                </symbol>
                <symbol id="icon-file-music" viewBox="0 0 1024 1024">
                    <title>file-music</title>
                    <path fill="#444444" class="path1" d="M917.806 229.076c-22.21-30.292-53.174-65.7-87.178-99.704s-69.412-64.964-99.704-87.178c-51.574-37.82-76.592-42.194-90.924-42.194h-496c-44.112 0-80 35.888-80 80v864c0 44.112 35.886 80 80 80h736c44.112 0 80-35.888 80-80v-624c0-14.332-4.372-39.35-42.194-90.924v0zM785.374 174.626c30.7 30.7 54.8 58.398 72.58 81.374h-153.954v-153.946c22.982 17.78 50.678 41.878 81.374 72.572v0zM896 944c0 8.672-7.328 16-16 16h-736c-8.672 0-16-7.328-16-16v-864c0-8.672 7.328-16 16-16 0 0 495.956-0.002 496 0v224c0 17.672 14.324 32 32 32h224v624z"></path>
                    <path fill="#444444" class="path2" d="M756.288 391.252c-7.414-6.080-17.164-8.514-26.562-6.632l-320 64c-14.958 2.994-25.726 16.126-25.726 31.38v236.876c-18.832-8.174-40.678-12.876-64-12.876-70.692 0-128 42.98-128 96s57.308 96 128 96 128-42.98 128-96v-229.766l256-51.202v133.842c-18.832-8.174-40.678-12.876-64-12.876-70.692 0-128 42.98-128 96s57.308 96 128 96 128-42.98 128-96v-319.998c0-9.586-4.298-18.668-11.712-24.748z"></path>
                </symbol>
                <symbol id="icon-file-video" viewBox="0 0 1024 1024">
                    <title>file-video</title>
                    <path fill="#444444" class="path1" d="M917.806 229.076c-22.208-30.292-53.174-65.7-87.178-99.704s-69.412-64.964-99.704-87.178c-51.574-37.82-76.594-42.194-90.924-42.194h-496c-44.112 0-80 35.888-80 80v864c0 44.112 35.882 80 80 80h736c44.112 0 80-35.888 80-80v-624c0-14.332-4.372-39.35-42.194-90.924v0 0zM785.374 174.626c30.7 30.7 54.8 58.398 72.58 81.374h-153.954v-153.946c22.98 17.78 50.678 41.878 81.374 72.572v0 0zM896 944c0 8.672-7.328 16-16 16h-736c-8.672 0-16-7.328-16-16v-864c0-8.672 7.328-16 16-16 0 0 495.956-0.002 496 0v224c0 17.672 14.32 32 32 32h224v624z"></path>
                    <path fill="#444444" class="path2" d="M256 512h320v320h-320v-320z"></path>
                    <path fill="#444444" class="path3" d="M576 640l192-128v320l-192-128z"></path>
                </symbol>
                <symbol id="icon-file-pdf" viewBox="0 0 1024 1024">
                    <title>file-pdf</title>
                    <path fill="#444444" class="path1" d="M842.012 589.48c-13.648-13.446-43.914-20.566-89.972-21.172-31.178-0.344-68.702 2.402-108.17 7.928-17.674-10.198-35.892-21.294-50.188-34.658-38.462-35.916-70.568-85.772-90.576-140.594 1.304-5.12 2.414-9.62 3.448-14.212 0 0 21.666-123.060 15.932-164.666-0.792-5.706-1.276-7.362-2.808-11.796l-1.882-4.834c-5.894-13.592-17.448-27.994-35.564-27.208l-10.916-0.344c-20.202 0-36.664 10.332-40.986 25.774-13.138 48.434 0.418 120.892 24.98 214.738l-6.288 15.286c-17.588 42.876-39.63 86.060-59.078 124.158l-2.528 4.954c-20.46 40.040-39.026 74.028-55.856 102.822l-17.376 9.188c-1.264 0.668-31.044 16.418-38.028 20.644-59.256 35.38-98.524 75.542-105.038 107.416-2.072 10.17-0.53 23.186 10.014 29.212l16.806 8.458c7.292 3.652 14.978 5.502 22.854 5.502 42.206 0 91.202-52.572 158.698-170.366 77.93-25.37 166.652-46.458 244.412-58.090 59.258 33.368 132.142 56.544 178.142 56.544 8.168 0 15.212-0.78 20.932-2.294 8.822-2.336 16.258-7.368 20.792-14.194 8.926-13.432 10.734-31.932 8.312-50.876-0.72-5.622-5.21-12.574-10.068-17.32zM211.646 814.048c7.698-21.042 38.16-62.644 83.206-99.556 2.832-2.296 9.808-8.832 16.194-14.902-47.104 75.124-78.648 105.066-99.4 114.458zM478.434 199.686c13.566 0 21.284 34.194 21.924 66.254s-6.858 54.56-16.158 71.208c-7.702-24.648-11.426-63.5-11.426-88.904 0 0-0.566-48.558 5.66-48.558v0zM398.852 637.494c9.45-16.916 19.282-34.756 29.33-53.678 24.492-46.316 39.958-82.556 51.478-112.346 22.91 41.684 51.444 77.12 84.984 105.512 4.186 3.542 8.62 7.102 13.276 10.65-68.21 13.496-127.164 29.91-179.068 49.862v0zM828.902 633.652c-4.152 2.598-16.052 4.1-23.708 4.1-24.708 0-55.272-11.294-98.126-29.666 16.468-1.218 31.562-1.838 45.102-1.838 24.782 0 32.12-0.108 56.35 6.072 24.228 6.18 24.538 18.734 20.382 21.332v0z"></path>
                    <path fill="#444444" class="path2" d="M917.806 229.076c-22.21-30.292-53.174-65.7-87.178-99.704s-69.412-64.964-99.704-87.178c-51.574-37.82-76.592-42.194-90.924-42.194h-496c-44.112 0-80 35.888-80 80v864c0 44.112 35.886 80 80 80h736c44.112 0 80-35.888 80-80v-624c0-14.332-4.372-39.35-42.194-90.924v0zM785.374 174.626c30.7 30.7 54.8 58.398 72.58 81.374h-153.954v-153.946c22.982 17.78 50.678 41.878 81.374 72.572v0zM896 944c0 8.672-7.328 16-16 16h-736c-8.672 0-16-7.328-16-16v-864c0-8.672 7.328-16 16-16 0 0 495.956-0.002 496 0v224c0 17.672 14.324 32 32 32h224v624z"></path>
                </symbol>
            </defs>
        </svg>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'ugo-previewer',

        properties: {
            /**
             * selector that point to the field we want to preview
             */
            selector: {
                type: String,
                value: null
            },

            /**
             * Base Url to add to source path
             */
            baseUrl: {
                type: String,
                value: ''
            },

            /**
             * Default image set in the src attribute
             * If the source value is empty then we put the placeholder
             */
            placeholder: {
                type: String,
                value: null
            },

            /**
             * Link label (the content of the a tag)
             * You can use vars such as {url}, {fileName}, {ext}
             */
            label: {
                type: String,
                value: 'Download {ext} file'
            },

            /**
             * Empty link label (the content of the a tag)
             * You can use vars such as {url}, {fileName}, {ext}
             */
            emptyLabel: {
                type: String,
                value: 'No file selected'
            },

            /**
             * Display icons for files when using a link previewer
             */
            displayIcons: {
                type: Boolean,
                value: false
            },

            /**
             * Events trigger the set media
             */
            event: {
                type: String,
                value: 'change keyup blur'
            },

            /**
             * Job interval
             */
            interval: {
                type: Number,
                value: 350
            }
        },

        /**
         * source we want to preview
         * @type {HTMLElement}
         */
        source: null,

        /**
         * target who will display the preview
         * @type {HTMLElement}
         */
        target: null,

        /**
         * Constructor
         */
        ready: function() {
            if (null !== this.selector) { //without selector attribute does nothing
                this.async(function() {
                    this.source = document.querySelector(this.selector);
                    this.target = Polymer.dom(this.$.contentPreviewer).getDistributedNodes()[0];
                    this.feedMedia();
                    this.addListeners();
                });
            }
            console.log('previewer ready');
            console.log(this);
        },

        /**
         * Set media to preview
         */
        feedMedia: function() {
            this.debounce('feedMedia', function () {
                var value = this.getSourceValue(),
                    media = this.baseUrl + value;

                if (value && this._isMedia(media)) {
                    try {
                        var xhr = new XMLHttpRequest();
                        xhr.open('HEAD', media, true);
                        xhr.onreadystatechange = function () {
                            if (xhr.readyState == 4) {
                                if(xhr.status == 200) {
                                    this.setTargetSource(media);
                                } else {
                                    this.feedMediaWithPlaceholder();
                                }
                            }
                        }.bind(this);
                        xhr.send(null);
                    } catch (e) {
                        this.feedMediaWithPlaceholder();
                    }

                } else {
                    this.feedMediaWithPlaceholder();
                }
            }.bind(this), this.interval);
        },

        /**
         * set preview with placeholder if placeholder is setted
         */
        feedMediaWithPlaceholder: function() {
            //Special case for links
            if (this.target.tagName == 'A') {
                this.target.removeAttribute('href');
                this.target.innerHTML = this.emptyLabel;
            } else {
                if (this.placeholder) {
                    this.setTargetSource(this.placeholder);
                } else {
                    this.setTargetSource('');
                }
            }
        },

        /**
         *  set the target source depending on its type (a -> href, img|video|audio -> src)
         */
        setTargetSource: function(value) {
            switch (this.target.tagName) {
                case 'A':
                    this.target.setAttribute('href', value);
                    this.target.innerHTML = this.getRichLabel(value);
                    break;
                default:
                    this.target.setAttribute('src', value);
                    break;
            }
        },

        /**
         *  Includes special vars in the label, and the icon if displayIcons is true
         *
         *  @returns {string}
         */
        getRichLabel: function(url) {
            //Get back rich vars
            var richLabel = this.label;
            var fileName = url.indexOf('/') != -1 ? url.slice(url.lastIndexOf('/') + 1, url.length) : '';
            var ext = fileName.indexOf('.') != -1 ? fileName.slice(fileName.lastIndexOf('.') + 1, fileName.length) : '';
            //Perform replacements
            richLabel = richLabel.replace(/\{url\}/g, url);
            richLabel = richLabel.replace(/\{fileName\}/g, fileName);
            richLabel = richLabel.replace(/\{ext\}/g, ext);
            //Add icon
            if (this.displayIcons) {
                var iconId = 'icon-file-empty';
                switch (ext.toLowerCase()) {
                    case 'mp3':
                        iconId = 'icon-file-music';
                        break;
                    case 'pdf':
                        iconId = 'icon-file-pdf';
                        break;
                    case 'jpg':
                    case 'jpeg':
                    case 'png':
                    case 'bmp':
                    case 'gif':
                        iconId = 'icon-file-picture';
                        break;
                    case 'avi':
                    case 'mov':
                        iconId = 'icon-file-video';
                        break;
                }
                richLabel = '<svg class="preview-icon '+iconId+'"><use xlink:href="#'+iconId+'"></use></svg>'+richLabel;
            }
            return richLabel;
        },

        /**
         * Get source value
         *
         * @returns {string|Number}
         */
        getSourceValue: function() {
            switch (this.source.tagName) {
                case 'SELECT':
                    return this.source.options[this.source.selectedIndex].value;
                    break;
                default:
                    return this.source.value;
                    break;
            }
        },

        /**
         * Add listeners
         */
        addListeners: function() {
            var events = this.event.split(' ');

            for (var i = 0; i < events.length; i++) {
                this.source.addEventListener(events[i], function() {
                    this.feedMedia();
                }.bind(this), false);
            }
        },

        /**
         * @return {Boolean}
         * @private
         */
        _isMedia: function(url) {
            var re = new RegExp('^.+\\.[a-z0-9].{1,4}$', 'i');

            return re.test(url);
        }
    });
</script>